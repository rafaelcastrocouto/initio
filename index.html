<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Language" content="en-US" />
    <meta name="Author" content="Rafael Castro Couto, rafaelcastrocouto@gmail.com">
    <style>
      table {border-collapse: collapse; margin: 6px;}
      table, td, canvas {border: 1px solid black}
      td {font-family: monospace; padding: 2px}
    </style>
  </head>
  <body>
    
    <div id="controls">
      <span>Fibo:</span><input type="text" id="fibo" value="6" size="1" class="editable"/>
      <span>Seq:</span><input type="text" id="seq" class="editable"/>
      <span>ELA(n):</span><input type="text" id="En" value="1000" size="3" class="editable"/>
      <span>ANN(n):</span><input type="text" id="An" value="200" size="3" class="editable"/>
      <span>Steps(n):</span><input type="text" id="N" value="10" size="3" class="editable"/>
      <span>Global Parameters:</span><input type="checkbox" id="gp" checked class="editable"/>      
      <br>
      <span>Eff:</span><input type="text" id="Eff" disabled size="40"/>
      <span>Rig:</span><input type="text" id="Rig" disabled size="30"/>
      <span>Progress:</span><input type="text" id="prog" value="0%" disabled size="3"/>      
    </div>  
    
    <table>
      <tbody id="table">
        <tr><th>Step</th><th>Angles</th><th>Energy</th></tr>
      </tbody>
    </table>
    
    <div id="results"></div>
    
    <div id="canvas"></div> 
    
    <input id="start" type="button" value="Start" class="editable"/>
    <input id="print" type="button" value="Print" class="editable"/>
    
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="protein.js"></script>
    <script type="text/javascript" src="energy.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="highcharts.js"></script>
    <script type="text/javascript" src="exporting.js"></script>
    <script type="text/javascript" src="print.js"></script>
    
    <script type="text/javascript">
      
      var seq;//'AB...';
      var Linearang;  //[0,0,...]
      var N, An, En; //global limits
      var sum_tests = 0; //to calculate avarage      
      var the_min; //{energy: Infinity};
      var prog, tprog, steps, num_steps, pr_in = $('#prog');
      var gpi, global_parameter = [];
      var fiboLength = $('#fibo');
      var controls = $('input.editable');
      var e_data = [], min_data = []; //chart database
      var results = $('#results'), table = $('#table');
      var canvas = $('#canvas');
      var start_time, end_time;
      
      var createCanvas = function(w, h){
        if(!h) h = w;
        var c = document.createElement('canvas');
        c.width = w; c.height = h;
        canvas.prepend(c);
        return c;
      };
      
      var gen_fibo_seq = function(){
        var n = parseInt(fiboLength.val());  
        if(n < Infinity) {
          seq = fibonacci(n);
          $('#seq').val(seq);  
        } else alert('Error: Sequence is too long.');
      };  
      
      var gen_linear_ang = function(){
        var a = [];
        var i = seq.length;  
        while(i) a[--i] = 0;  
        return a;
      };
      
      var load = function(){
        
        gen_fibo_seq();        
        fiboLength.on('keyup change', gen_fibo_seq);
        
        $('#print').on('click', function(){
          window.print();
        });
        
        $('#start').on('click', function(){
          start_time = new Date();
          
          N = parseInt($('#N').val());          
          An = parseInt($('#An').val());
          En = parseInt($('#En').val());
          num_steps = ((An + En) / 100);
          tprog = num_steps * N;
          prog = 0;
          pr_in.val('0%');//prog / tprog
          
          results.html('');
          canvas.html('');
          table.html('<tr><th>Step</th><th>Angles</th><th>Energy</th></tr>');
          controls.attr('disabled', true);
          
          e_data = []; min_data = [];
          sum_tests = 0;
          steps = 0;
          the_min = {energy: Infinity};          
          
          gpi = $('#gp').prop('checked');
          if(gpi) global_parameter = gen_parameter();
          
          Linearang = gen_linear_ang();            
          test_protein();
        });  
        
        //$('#start').click();
        
      };       
      
      //tests loop
      var test_protein = function(P){
        if(P) { // won't happen on 1st call
          sum_tests += P.energy;
          if(P.energy < the_min.energy) the_min = P;    
        }
        if(steps < N) {
          
          var obj = {
            seq: seq,
            ang: Linearang,
            l: En
          };
          
          var p = new Protein(obj);
          
          e_data.push(p.energy);
          
          if(gpi) obj.parameter = global_parameter;
          else    obj.parameter = gen_parameter();
          
          ela_worker.postMessage(JSON.stringify(obj));
          
        } else end(); 
        
        ++steps;
      };   
      
      //workers
      var ela_worker = new Worker('ela.js');
      ela_worker.addEventListener('error', onError, false);
      ela_worker.addEventListener('message', function(e) {
        var data = JSON.parse(e.data); 
        if(data.log) console.log(data.log);
        if(data.parameter) {
          printParameters(data.parameter); 
          if(gpi) global_parameter = data.parameter;
        }
        if(data.data) {
          e_data.push(data.data);
          prog += 100;
          pr_in.val( (prog / tprog).toFixed(1)+'%');
        }
        if(data.ang) {
          e_data.push(data.energy);
          var msg = JSON.stringify({seq: seq, ang: data.ang, l: An});
          ann_worker.postMessage(msg);  
        }
      }, false);
      
      //PARAMETERS
      var $eff = $('#Eff'), $rig =  $('#Rig');
      
      var gen_parameter = function(){
        var parameter = [];        
        for(var i = 1; i < seq.length; ++i){
          parameter[i] = {};          
          parameter[i].efficiency = 100;
          parameter[i].rigidity = 1;
        }
        return parameter;
      };     
      
      var printParameters = function(parameter){
        var eff = [], rig = [];
        for(var i = 1; i < parameter.length - 1; ++i){
          rig.push( Number(parameter[i].rigidity).toFixed(1) );
          eff.push( Number(parameter[i].efficiency).toFixed(1) );
        }
        $eff.val( eff.join(',') ); 
        $rig.val( rig.join(',') );        
      };      
      
      var ann_worker = new Worker('ann.js');
      ann_worker.addEventListener('error', onError, false);
      ann_worker.addEventListener('message', function(e) { 
        var data = JSON.parse(e.data);
        if(data.log) console.log(data.log);
        if(data.data) {
          e_data.push(data.data);
          prog += 100;
          pr_in.val( (prog / tprog).toFixed(2)+'%');
        }
        if(data.ang) {
          e_data.push(data.energy);
          min_data.push(data.energy);console.log();
          table.append(
            $(['<tr>',
             '<td>'+steps+'</td>',
             '<td>'+data.ang.join(', ')+'</td>',
             '<td>'+data.energy+'</td>',
            '</tr>'].join(''))
          );
          var p = new Protein({'seq': seq, 'ang': data.ang});
          test_protein(p);
        }
      }, false); 
      
      var end = function(){
        end_time = new Date();
        
        results
          .append($('<p>Start: '+start_time+'<br>End: '+end_time+'</p>'))
          .append($('<p>Duration: '+(end_time - start_time)/1000+' seconds</p>'))
          .append($('<p>Avarage Energy (Sum/'+N+'): '+(sum_tests/N)+'</p>'))
          .append($('<p>Minimum Energy: '+the_min.energy+'</p>'));
        
        final_chart(e_data);    
        the_min.render();
        controls.attr('disabled', false);
      };      
      
      $(load);     
      
    </script>    
  </body>
</html>