<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Language" content="en-US" />
    <meta name="Author" content="Rafael Castro Couto, rafaelcastrocouto@gmail.com">
    <style>
      body {min-width: 600px;}
      table {border-collapse: collapse;}
      table, td, canvas {border: 1px solid #aaa}
      .container {border: 1px solid #000; padding: 6px; border-radius: 6px;}
      td {font-family: monospace; padding: 2px}
      table, canvas, h3, .container, p {margin: 6px}
      table, canvas {width: calc(100% - 12px)}
      span {white-space: nowrap}
      input[type="text"] {text-align: right}
    </style>
  </head>
  <body>
    
    <div id="controls">
      <span>Total Progress: <progress title="0%" id="total_prog" value="0"></progress></span>
      <span>Test Progress: <progress title="0%" id="prog" value="0"></progress></span>
      <br>
      <span>Sequences: F6(13) F7(21) F8(34) F9(55) 1AGT(38) 1AHO(64) 
        <input type="text" id="seqs" value="F6,F8,1AGT" size="15" class="editable"/>
      </span>
      <span>Steps:<input type="text" id="steps" value="4,2" size="5" class="editable"/></span><br>
      <span>ELA(N):<input type="text" id="En" value="1000,500" size="10" class="editable"/></span>
      <span>Pop:<input type="text" id="Pop" value="400,200" size="5" class="editable"/></span>    
      <span>Parents:<input type="text" id="Parent" value="50,25" size="5" class="editable"/>% </span>    
      <span>Angles:<input type="text" id="Ang_num" value="2,4" size="5" class="editable"/></span>    
      <span>Global Parameters:<input type="checkbox" id="gp" checked class="editable"/></span><br>
      <span>Eff:<input type="text" id="Eff" disabled size="40"/></span>
      <span>Success:<input type="text" id="Eff_success" value="+2" size="10" class="editable"/></span>    
      <span>Fail:<input type="text" id="Eff_fail" value="-0.000001" size="10" class="editable"/></span><br>    
      <span>Rig:<input type="text" id="Rig" disabled size="40"/></span>
      <span>Success:<input type="text" id="Rig_success" value="+1" size="10" class="editable"/></span>    
      <span>Fail:<input type="text" id="Rig_fail" value="-0.00001" size="10" class="editable"/></span>
      <span>Rig Max:<input type="text" id="Rig_max" value="3" size="10" class="editable"/></span><br>
      <span>Ann(N):<input type="text" id="An" value="200" size="10" class="editable"/></span>
      <input id="start" type="button" value="Start" class="editable"/>
      <input id="print" type="button" value="Print" class="editable"/>
    </div>  
    
    <div id="results"></div> 
    
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="protein.js"></script>
    <script type="text/javascript" src="energy.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="highcharts.js"></script>
    <script type="text/javascript" src="exporting.js"></script>
    <script type="text/javascript" src="print.js"></script>
    
    <script type="text/javascript">
      //SEQs
      var pre_seqs = { // F6(13) F7(21) F8(34) F9(55) 1AGT(38) 1AHO(64)
        'F6': fibonacci(6), // ABBABBABABBAB
        'F7': fibonacci(7), // BABABBABABBABBABABBAB
        'F8': fibonacci(8), // ABBABBABABBABBABABBABABBABBABABBAB
        'F9': fibonacci(9), // BABABBABABBABBABABBABABBABBABABBABBABABBABABBABBABABBAB           
        '1AGT': realToAb('GVPINVSCTGSPQCIKPCKDAGMRFGKCMNRKCHCTPK'), 
        // AAAABABABABABAABAABBAAABBABAABBBABABAB
        '1AHO': realToAb('VKDGYIVDDVNCTYFCGRNAYCNEECTKLKGESGYCQWASPYGNACYCYKLPDHVRTKGPGRCH') 
        // ABBABAABBABABBBAABBABABBBABBABABBABABBABABABAABABBAABBABBBAAABAB
      };
      //GLOBALS
      var Linearang;  //[0,0,...]
      var $seqs = $('#seqs'), current_seq, aseqs, seq_name;
      var $steps = $('#steps'), current_step, steps, asteps;
      var $Pop = $('#Pop'), aPop, pop;
      var $Parent = $('#Parent'), aParent, parent;
      var $Ang_num = $('#Ang_num'), aAng_num, ang_num;
      var test, total_tests, test_counter = 1;
      var An, $An = $('#An'), aAn;
      var En, $En = $('#En'), aEn; 
      var the_min, avg_en;
      var $total_prog = $('#total_prog'), total_prog;
      var $prog = $('#prog'), prog;       
      var gpi, global_parameter = [], $gp = $('#gp');
      var $controls = $('input.editable');
      var e_data = [], min_data = []; 
      var $results = $('#results'), $container, $table, $canvas;
      var start_time, end_time;
      var $eff = $('#Eff');
      var $effs = $('#Eff_success'), aeffs, effs; 
      var $efff = $('#Eff_fail'), aefff, efff;
      var $rig =  $('#Rig');
      var $rigs = $('#Rig_success'), arigs, rigs; 
      var $rigf = $('#Rig_fail'), arigf, rigf;
      var $rigm = $('#Rig_max'), arigm, rigm;
      
      var createCanvas = function(w, h){
        if(!h) h = w;
        var c = document.createElement('canvas');
        c.width = w; c.height = h;
        $canvas.prepend(c);
        return c;
      };
      
      var gen_linear_ang = function(){
        var a = [];
        var i = current_seq.length;  
        while(i) a[--i] = 0;  
        return a;
      };
      
      var progress_bar = function(){
        prog += 100;
        var p = prog/total_prog;
        $prog.attr('title', (p*100).toFixed(0) + '%');
        $prog.val(p);
      };
      
      var total_progress_bar = function(){
        var p = test/total_tests;
        $total_prog.attr('title', (p*100).toFixed(0) + '%');
        $total_prog.val(p);        
      };
      
      var load = function(){       
        $('#start').on('click', function(){
          start_time = new Date();
          
          $controls.attr('disabled', true);
          
          aseqs = $seqs.val().split(',');          
          asteps = $steps.val().split(',');
          aAn = $An.val().split(',');
          aEn = $En.val().split(',');    
          aPop = $Pop.val().split(',');    
          aParent = $Parent.val().split(',');    
          aAng_num = $Ang_num.val().split(',');    
          arigf = $rigf.val().split(',');    
          arigs = $rigs.val().split(',');    
          arigm = $rigm.val().split(',');    
          aefff = $efff.val().split(',');    
          aeffs = $effs.val().split(',');    
          
          total_tests = Math.max(
            aseqs.length, 
            asteps.length, 
            aAn.length, 
            aEn.length,
            aPop.length, 
            aParent.length, 
            aAng_num.length, 
            arigf.length, 
            arigs.length,  
            aefff.length,     
            aeffs.length
          );         
          
          gpi = $gp.prop('checked');
          
          test = 0;        
          test_protein();
        });  
        $('#print').on('click', function(){
          window.print();
        });
      };       
      
      var test_protein = function(){ 
        if(test < total_tests) {           
          if(aseqs[test]) {
            seq_name = aseqs[test];
            current_seq = pre_seqs[seq_name];
          }
          if(asteps[test]) steps = parseInt(asteps[test]);          
          if(aAn[test]) An = parseInt(aAn[test]) ;
          if(aEn[test]) En = parseInt(aEn[test]);        
          if(aPop[test]) pop = parseInt(aPop[test]);        
          if(aParent[test]) parent = parseFloat(aParent[test])/100;        
          if(aAng_num[test]) ang_num = parseInt(aAng_num[test]);        
          if(aefff[test]) efff = aefff[test];        
          if(aeffs[test]) effs = aeffs[test];        
          if(arigs[test]) rigs = arigs[test];        
          if(arigf[test]) rigf = arigf[test];        
          if(arigm[test]) rigm = parseInt(arigm[test]);        

          total_prog = (An + En) * steps;            

          Linearang = gen_linear_ang(); 
          if(gpi) global_parameter = gen_parameter();         
                  
          e_data = []; min_data = [];  
          avg_en = 0;          
          prog = 0;
          the_min = {energy: Infinity};   
       
          $container = $('<div>').addClass('container');
          $container.append('<h3>Test '+(test_counter)+'<h3>');
          $container.append('<p>Sequence: '+seq_name+'('+current_seq.length+') ['+current_seq+']<p>');
          $container.append('<p>ELA(N): '+En+', Pop: '+pop+', Parent: '+(parent*100)+'%, Angles: '+ang_num+', Ann(N): '+An+'<p>');
          $container.append('<p>Parameters Global: '+gpi+', Eff Success: '+effs+', Fail: '+efff+', Rig Success: '+rigs+', Fail: '+rigf+', Max: '+rigm+'<p>');
          $table = $('<table><tr><th>Step</th><th>Angles</th><th>Energy</th></tr></table>');
          $canvas = $('<div>');
          $container.append($table).append($canvas);
          $results.prepend($container);
          
          current_step = 0;
          step_protein();
          ++test; ++test_counter;
        } else  $controls.attr('disabled', false); 
      }
      
      //step loop
      var step_protein = function(P){ 
        if(P) { // won't happen on 1st call
          avg_en += P.energy;
          if(P.energy < the_min.energy) the_min = P;  
        } 
        if(current_step < steps) {
                    
          /*if(the_min.getAngle) //uncomment to keep min
            var oa = the_min.getAngle(2);
          else */  var oa = Linearang;
          
          var p = new Protein({seq: current_seq, ang: oa});          
          e_data.push(p.energy);          
          
          var obj = { 
            seq: current_seq, 
            ang: oa, 
            l: En, 
            pop: pop,
            parent: parent,
            ang_num: ang_num,
            efff: efff,
            effs: effs,
            rigf: rigf,
            rigs: rigs,         
            rigm: rigm         
          };
          
          if(gpi) obj.parameter = global_parameter;
          else    obj.parameter = gen_parameter();

          ela_worker.postMessage(JSON.stringify(obj));          
          ++current_step;          
        } else plot();        
      };   
      
      //workers
      var ela_worker = new Worker('ela.js');
      ela_worker.addEventListener('error', onError, false);
      ela_worker.addEventListener('message', function(e) {
        var data = JSON.parse(e.data); 
        if(data.log) console.log(data.log);
        if(data.parameter) {
          printParameters(data.parameter); 
          if(gpi) global_parameter = data.parameter;
        }
        if(data.data) {
          e_data.push(data.data);          
          progress_bar();
        }
        if(data.ang) {
          e_data.push(data.energy);
          var msg = JSON.stringify({seq: current_seq, ang: data.ang, l: An});
          ann_worker.postMessage(msg);  
        }
      }, false);
      
      var gen_parameter = function(){
        var parameter = [];        
        for(var i = 1; i < current_seq.length; ++i){
          parameter[i] = {};          
          parameter[i].efficiency = 1;
          parameter[i].rigidity = 1;
        }
        return parameter;
      };     
      
      var printParameters = function(parameter){
        var eff = [], rig = [];
        for(var i = 1; i < parameter.length - 1; ++i){
          rig.push( Number(parameter[i].rigidity).toFixed(0) );
          eff.push( Number(parameter[i].efficiency).toFixed(0) );
        }
        $eff.val( eff.join(',') ); 
        $rig.val( rig.join(',') );        
      };      
      
      var ann_worker = new Worker('ann.js');
      ann_worker.addEventListener('error', onError, false);
      ann_worker.addEventListener('message', function(e) { 
        var data = JSON.parse(e.data);
        if(data.log) console.log(data.log);
        if(data.data) {
          e_data.push(data.data);
          progress_bar();
        }
        if(data.ang) {
          var angstr = data.ang.slice(1).join(', ');
          e_data.push(data.energy);
          min_data.push(data.energy);
          $table.append($(['<tr>',
             '<td>'+current_step+'</td>',
             '<td>'+angstr+'</td>',
             '<td>'+data.energy+'</td>',
             '</tr>'].join('')));
          var p = new Protein({'seq': current_seq, 'ang': data.ang});                 
          step_protein(p);
        }
      }, false); 
      
      var plot = function(){
        end_time = new Date();       
        var duration = (end_time - start_time)/1000;
        $container
          .append($('<p>Start: '+start_time+'<br>End: '+end_time+'</p>'))
          .append($('<p>Time: '+duration+' seconds</p>'))
          .append($('<p>Avarage Duration (Time/'+steps+'): '+(duration/steps).toFixed(3)+' seconds</p>'))
          .append($('<p>Avarage Energy (Sum/'+steps+'): '+(avg_en/steps)+'</p>'))
          .append($('<p>Minimum Energy: '+the_min.energy+'</p>'));
        
        final_chart(e_data);
        console.log(the_min) 
        the_min.render();
        total_progress_bar(); 
        test_protein();
      };      
      
      $(load);     
      
    </script>    
  </body>
</html>